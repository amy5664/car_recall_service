<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.RecallDAO">

    <insert id="insertRecall" parameterType="com.boot.dto.RecallDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO RECALL (
        MAKER, MODEL_NAME, MAKE_START, MAKE_END,
        RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        ) VALUES (
        #{maker}, #{modelName}, #{makeStart}, #{makeEnd},
        #{recallDate}, #{recallReason}, #{vin}, #{registrationNumber}
        )
    </insert>

    <insert id="insertRecallList" parameterType="java.util.List">
        INSERT INTO RECALL (MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER)
        VALUES
        <foreach collection="list" item="recall">
            (#{recall.maker}, #{recall.modelName}, #{recall.makeStart}, #{recall.makeEnd}, #{recall.recallDate}, #{recall.recallReason}, #{recall.vin}, #{recall.registrationNumber})
        </foreach>
    </insert>

    <resultMap id="recallResultMap" type="com.boot.dto.RecallDTO">
        <id property="id" column="ID"/>
        <result property="maker" column="MAKER" />
        <result property="modelName" column="MODEL_NAME" />
        <result property="makeStart" column="MAKE_START" />
        <result property="makeEnd" column="MAKE_END" />
        <result property="recallDate" column="RECALL_DATE" />
        <result property="recallReason" column="RECALL_REASON" />
        <result property="vin" column="VIN" />
        <result property="registrationNumber" column="REGISTRATION_NUMBER" />
    </resultMap>

    <sql id="searchCondition">
        <where>
            <if test="maker != null and maker != ''">
                AND UPPER(MAKER) LIKE CONCAT('%', UPPER(#{maker}), '%')
            </if>
            <if test="modelName != null and modelName != ''">
                AND UPPER(MODEL_NAME) LIKE CONCAT('%', UPPER(#{modelName}), '%')
            </if>
            <if test="startDate != null and startDate != ''">
                AND RECALL_DATE &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND RECALL_DATE &lt;= #{endDate}
            </if>
        </where>
    </sql>

    <select id="selectAllWithoutPagings" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON
        FROM RECALL
        ORDER BY ID DESC
    </select>

    <select id="selectAll" parameterType="com.boot.dto.Criteria" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        <include refid="searchCondition" />
        ORDER BY ID DESC
        LIMIT #{amount} OFFSET ${(pageNum - 1) * amount}
    </select>

    <select id="count" parameterType="com.boot.dto.Criteria" resultType="int">
        SELECT COUNT(*) FROM RECALL
        <include refid="searchCondition" />
    </select>

    <select id="searchByModelName" parameterType="string" resultMap="recallResultMap">
        SELECT
        ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE UPPER(MODEL_NAME) LIKE CONCAT('%', UPPER(#{modelName}), '%')
        ORDER BY RECALL_DATE DESC
    </select>
    
    <select id="selectDistinctMaker" resultType="string">
    	SELECT DISTINCT MAKER
    	FROM RECALL
    	WHERE MAKER IS NOT NULL
      		AND TRIM(MAKER) != ''
    	ORDER BY MAKER
    </select>

    <select id="selectAllWithoutPaging" resultMap="recallResultMap">
        SELECT
        ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON
        FROM RECALL
        ORDER BY ID DESC
    </select>

    <select id="selectById" parameterType="long" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE ID = #{id}
    </select>
    
        <!-- Î¶¨ÏΩú ÌÜµÍ≥Ñ ÏßëÍ≥Ñ ÏøºÎ¶¨ -->
    <select id="selectRecallStats"
        parameterType="com.boot.dto.RecallStatsFilterDTO"
        resultType="com.boot.dto.RecallStatsRowDTO">

    SELECT
        <!-- Í≥µÌÜµ Ïª¨Îüº: Ï†úÏ°∞ÏÇ¨ / Î™®Îç∏Î™Ö -->
        <choose>
            <!-- üîπ Î™®Îç∏ Í∏∞Ï§Ä: Ï†úÏ°∞ÏÇ¨ + Î™®Îç∏Î™Ö Îëò Îã§ ÏÇ¨Ïö© -->
            <when test="groupBy == 'MODEL'">
                r.MAKER      AS maker,
                r.MODEL_NAME AS modelName,
                r.MODEL_NAME AS groupName
            </when>

            <!-- üîπ Ï†úÏ°∞ÏÇ¨ Í∏∞Ï§Ä: Ï†úÏ°∞ÏÇ¨Îßå Í∑∏Î£π, modelNameÏùÄ ÏùòÎØ∏ ÏóÜÏùå -->
            <otherwise>
                r.MAKER      AS maker,
                GROUP_CONCAT(DISTINCT r.MODEL_NAME ORDER BY r.MODEL_NAME SEPARATOR ', ') AS modelName,
        		r.MAKER AS groupName
            </otherwise>
        </choose>
        ,

        <!-- Í∏∞Í∞Ñ Î†àÏù¥Î∏î -->
        <choose>
            <!-- Î∂ÑÍ∏∞Î≥Ñ -->
            <when test="timeUnit == 'QUARTER'">
                CONCAT(
                    YEAR(STR_TO_DATE(r.RECALL_DATE, '%Y-%m-%d')),
                    ' Q',
                    QUARTER(STR_TO_DATE(r.RECALL_DATE, '%Y-%m-%d'))
                ) AS periodLabel
            </when>

            <!-- ÏÉÅ¬∑ÌïòÎ∞òÍ∏∞ -->
            <when test="timeUnit == 'HALF_YEAR'">
                CONCAT(
                    YEAR(STR_TO_DATE(r.RECALL_DATE, '%Y-%m-%d')),
                    CASE
                        WHEN MONTH(STR_TO_DATE(r.RECALL_DATE, '%Y-%m-%d')) &lt;= 6
                             THEN ' ÏÉÅÎ∞òÍ∏∞'
                        ELSE ' ÌïòÎ∞òÍ∏∞'
                    END
                ) AS periodLabel
            </when>

            <!-- Í∏∞Î≥∏: ÏõîÎ≥Ñ -->
            <otherwise>
                DATE_FORMAT(
                    STR_TO_DATE(r.RECALL_DATE, '%Y-%m-%d'),
                    '%Y-%m'
                ) AS periodLabel
            </otherwise>
        </choose>
        ,

        -- Î¶¨ÏΩú Í±¥Ïàò
        COUNT(DISTINCT r.ID) AS recallCount

    FROM RECALL r
    WHERE 1 = 1

        <!-- ÎÇ†Ïßú ÌïÑÌÑ∞: Î¨∏ÏûêÏó¥ ÎπÑÍµê -->
        <if test="startDate != null and startDate != ''">
            AND r.RECALL_DATE &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND r.RECALL_DATE &lt;= #{endDate}
        </if>

        <!-- Ï†úÏ°∞ÏÇ¨ Î∂ÄÎ∂Ñ Í≤ÄÏÉâ -->
        <if test="maker != null and maker != ''">
            AND UPPER(r.MAKER) LIKE CONCAT('%', UPPER(#{maker}), '%')
        </if>

        <!-- Î™®Îç∏ Î∂ÄÎ∂Ñ Í≤ÄÏÉâ -->
        <if test="modelKeyword != null and modelKeyword != ''">
            AND UPPER(r.MODEL_NAME) LIKE CONCAT('%', UPPER(#{modelKeyword}), '%')
        </if>

    GROUP BY
        <choose>
            <!-- üîπ Î™®Îç∏ Í∏∞Ï§Ä: maker + modelName + periodLabel Î™®Îëê Í∑∏Î£π -->
            <when test="groupBy == 'MODEL'">
                r.MAKER,
                r.MODEL_NAME,
                periodLabel
            </when>

            <!-- üîπ Ï†úÏ°∞ÏÇ¨ Í∏∞Ï§Ä: maker + periodLabelÎßå Í∑∏Î£π -->
            <otherwise>
                r.MAKER,
                periodLabel
            </otherwise>
        </choose>

    ORDER BY
        periodLabel ASC,
        recallCount DESC
</select>

    <select id="searchByVin" parameterType="string" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE UPPER(VIN) LIKE CONCAT('%', UPPER(#{vin}), '%')
        ORDER BY RECALL_DATE DESC
    </select>

    <select id="searchByRegistrationNumber" parameterType="string" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE UPPER(REGISTRATION_NUMBER) LIKE CONCAT('%', UPPER(#{registrationNumber}), '%')
        ORDER BY RECALL_DATE DESC
    </select>

</mapper>
